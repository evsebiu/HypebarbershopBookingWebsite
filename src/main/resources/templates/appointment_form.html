<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Alege Data și Ora</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"> <style>
    /* Stiluri pentru butoanele de ore */
    #slots-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    .time-slot {
        padding: 10px;
        background: #1a1a1a;
        border: 1px solid #333;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }
    .time-slot:hover {
        border-color: var(--accent-gold);
        background: rgba(212, 175, 55, 0.1);
    }
    .time-slot.selected {
        background: var(--accent-gold);
        color: #000;
        font-weight: bold;
        border-color: var(--accent-gold);
    }
    /* Ascundem input-ul original de datetime-local pentru că folosim sistemul custom */
    .hidden-input {
        display: none;
    }
</style>
</head>
<body>

<header>
    <div class="logo-container">HYPE BARBERSHOP</div>
</header>

<main>
    <section>
        <div class="form-container">
            <h2 class="section-title">Programare la <span th:text="${barber.firstName}">Frizer</span></h2>

            <form th:action="@{/appointment/save}" th:object="${appointment}" method="post" id="bookingForm">

                <input type="hidden" id="barberId" name="barberId" th:value="${barber.id}" />
                <input type="hidden" id="serviceId" name="serviceId" th:value="${service.id}" />

                <input type="hidden" id="finalStartTime" th:field="*{startTime}" required />

                <div class="form-group">
                    <label>Nume</label>
                    <input type="text" th:field="*{clientName}" required>
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="text" th:field="*{phoneNumber}" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" th:field="*{clientEmail}" required>
                </div>

                <div class="form-group">
                    <label>Alege Ziua</label>
                    <input type="text" id="date-picker" placeholder="Apasă pentru calendar..." style="cursor: pointer;">
                </div>

                <div class="form-group">
                    <label id="slots-label" style="display:none;">Ore Disponibile</label>
                    <div id="slots-container"></div>
                    <p id="no-slots-msg" style="color: #ff4444; display: none; margin-top:10px;">Nu sunt locuri libere în această zi.</p>
                </div>

                <button type="submit" class="btn-cta" id="submitBtn" disabled style="opacity: 0.5; margin-top: 20px;">Confirmă Programarea</button>
            </form>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const barberId = document.getElementById('barberId').value;
        const serviceId = document.getElementById('serviceId').value;
        const slotsContainer = document.getElementById('slots-container');
        const finalInput = document.getElementById('finalStartTime');
        const submitBtn = document.getElementById('submitBtn');
        let selectedDate = null;

        // Inițializare Calendar Flatpickr
        flatpickr("#date-picker", {
            minDate: "today", // Nu lăsăm userul să aleagă trecutul
            dateFormat: "Y-m-d",
            disable: [
                function(date) {
                    // Opțional: Dezactivăm duminica (0 este duminică)
                    return (date.getDay() === 0);
                }
            ],
            onChange: function(selectedDates, dateStr, instance) {
                selectedDate = dateStr;
                fetchSlots(dateStr);
            }
        });

        // Funcția care cere orele de la server
        function fetchSlots(dateStr) {
            slotsContainer.innerHTML = '<p style="color:#888;">Se caută ore...</p>';
            document.getElementById('slots-label').style.display = 'block';
            document.getElementById('no-slots-msg').style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';

            // Apelăm endpoint-ul creat la Pasul 2
            fetch(`/api/appointments/slots?barberId=${barberId}&serviceId=${serviceId}&date=${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    slotsContainer.innerHTML = '';

                    if (data.length === 0) {
                        document.getElementById('no-slots-msg').style.display = 'block';
                        return;
                    }

                    // Creăm butoane pentru fiecare oră
                    data.forEach(time => {
                        const btn = document.createElement('div');
                        btn.className = 'time-slot';
                        btn.innerText = time;
                        btn.onclick = () => selectTime(btn, time);
                        slotsContainer.appendChild(btn);
                    });
                })
                .catch(err => {
                    console.error('Eroare:', err);
                    slotsContainer.innerHTML = '<p style="color:red;">Eroare la încărcarea orelor.</p>';
                });
        }

        // Când utilizatorul apasă pe o oră
        function selectTime(element, time) {
            // Scoatem selecția de pe celelalte
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));

            // Selectăm butonul curent
            element.classList.add('selected');

            // Construim formatul final ISO pentru Java: 2025-12-31T14:30
            const finalDateTime = `${selectedDate}T${time}`;
            finalInput.value = finalDateTime;

            // Activăm butonul de submit
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
        }
    });
</script>

</body>
</html>